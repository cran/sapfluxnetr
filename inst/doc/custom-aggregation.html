<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Victor Granda (Sapfluxnet Team)" />

<meta name="date" content="2020-05-11" />

<title>Custom aggregation</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Custom aggregation</h1>
<h4 class="author">Victor Granda (Sapfluxnet Team)</h4>
<h4 class="date">2020-05-11</h4>



<p><code>sapfluxnetr</code> package offers a very flexible but powerful API based on the <code>tidyverse</code> packages to aggregate and summarise the site/s data in the form of the <code>sfn_metrics</code> function. All the metrics family of functions (<code>?metrics</code>) make use of the <code>sfn_metrics</code> funcion under the hood. If you want full control to the statistics returned and aggregation periods, we recommend you to use this API. This vignette will show you how.</p>
<div id="pre-fixed-summarising-functions" class="section level2">
<h2>Pre-fixed summarising functions</h2>
<ol style="list-style-type: decimal">
<li><code>daily_metrics</code></li>
<li><code>monthly_metrics</code></li>
<li><code>predawn_metrics</code></li>
<li><code>midday_metrics</code></li>
<li><code>nightly_metrics</code></li>
<li><code>daylight_metrics</code></li>
</ol>
<p>See each function help for a detailed description and examples of use.</p>
</div>
<div id="custom-summarising-functions" class="section level2">
<h2>Custom summarising functions</h2>
<p><code>daily_metrics</code> and related functions return a complete set of metrics ready for use, but if you want simpler metrics and/or different metrics you can supply your own summarising functions using the <code>.funs</code> argument.<br />
The correct way of specifying the functions to use is described in the <code>summarise_all</code> help (<code>?dplyr::summarise_all</code>). The recommended way is a list of formulas with the function call:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># libraries</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(sapfluxnetr)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&gt; </span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#&gt; Attaching package: &#39;dplyr&#39;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#&gt; The following objects are masked from &#39;package:stats&#39;:</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&gt; </span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt;     filter, lag</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt; The following objects are masked from &#39;package:base&#39;:</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt; </span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">### only mean and sd at a daily scale</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># data</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">data</span>(<span class="st">&#39;ARG_TRE&#39;</span>, <span class="dt">package =</span> <span class="st">&#39;sapfluxnetr&#39;</span>)</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># summarising funs (as a list of formulas)</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>custom_funs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">mean =</span> <span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(., <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">std_dev =</span> <span class="op">~</span><span class="st"> </span><span class="kw">sd</span>(., <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co"># metrics</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>foo_simpler_metrics &lt;-<span class="st"> </span><span class="kw">sfn_metrics</span>(</span>
<span id="cb1-22"><a href="#cb1-22"></a>  ARG_TRE,</span>
<span id="cb1-23"><a href="#cb1-23"></a>  <span class="dt">period =</span> <span class="st">&#39;1 day&#39;</span>,</span>
<span id="cb1-24"><a href="#cb1-24"></a>  <span class="dt">.funs =</span> custom_funs,</span>
<span id="cb1-25"><a href="#cb1-25"></a>  <span class="dt">solar =</span> <span class="ot">TRUE</span>,</span>
<span id="cb1-26"><a href="#cb1-26"></a>  <span class="dt">interval =</span> <span class="st">&#39;general&#39;</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>)</span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">#&gt; [1] &quot;Crunching data for ARG_TRE. In large datasets this could take a while&quot;</span></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="co">#&gt; [1] &quot;General data for ARG_TRE&quot;</span></span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a>foo_simpler_metrics[[<span class="st">&#39;sapf&#39;</span>]]</span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co">#&gt; # A tibble: 14 x 9</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="co">#&gt;    TIMESTAMP           ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_…</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="co">#&gt;    &lt;dttm&gt;                         &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="co">#&gt;  1 2009-11-17 00:00:00             308.             173.             303.</span></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="co">#&gt;  2 2009-11-18 00:00:00             507.             376.             432.</span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="co">#&gt;  3 2009-11-19 00:00:00             541.             380.             391.</span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="co">#&gt;  4 2009-11-20 00:00:00             330.             218.             272.</span></span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="co">#&gt;  5 2009-11-21 00:00:00             338.             219.             278.</span></span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="co">#&gt;  6 2009-11-22 00:00:00             384.             243.             310.</span></span>
<span id="cb1-41"><a href="#cb1-41"></a><span class="co">#&gt;  7 2009-11-23 00:00:00             492.             300.             390.</span></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="co">#&gt;  8 2009-11-24 00:00:00             573.             389.             497.</span></span>
<span id="cb1-43"><a href="#cb1-43"></a><span class="co">#&gt;  9 2009-11-25 00:00:00             601.             400.             484.</span></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="co">#&gt; 10 2009-11-26 00:00:00             502.             360.             450.</span></span>
<span id="cb1-45"><a href="#cb1-45"></a><span class="co">#&gt; 11 2009-11-27 00:00:00             544.             411.             506.</span></span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="co">#&gt; 12 2009-11-28 00:00:00             573.             451.             589.</span></span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="co">#&gt; 13 2009-11-29 00:00:00             371.             285.             357.</span></span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="co">#&gt; 14 2009-11-30 00:00:00             386.             293.             381.</span></span>
<span id="cb1-49"><a href="#cb1-49"></a><span class="co">#&gt; # … with 5 more variables: ARG_TRE_Nan_Jt_4_mean &lt;dbl&gt;,</span></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_1_std_dev &lt;dbl&gt;, ARG_TRE_Nan_Jt_2_std_dev &lt;dbl&gt;,</span></span>
<span id="cb1-51"><a href="#cb1-51"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_3_std_dev &lt;dbl&gt;, ARG_TRE_Nan_Jt_4_std_dev &lt;dbl&gt;</span></span></code></pre></div>
<blockquote>
<p>When supplying only one function to .funs, names of variables are not changed to contain the metric name at the end, as the summary function returns the same columns as the original data</p>
</blockquote>
</div>
<div id="special-interest-intervals" class="section level2">
<h2>Special interest intervals</h2>
<p>You can also choose if the “special interest” intervals (predawn, midday, nighttime or daylight) are calculated or not. For example, if you are only interested in the midday interval you can use:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>foo_simpler_metrics_midday &lt;-<span class="st"> </span><span class="kw">sfn_metrics</span>(</span>
<span id="cb2-2"><a href="#cb2-2"></a>  ARG_TRE,</span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">period =</span> <span class="st">&#39;1 day&#39;</span>,</span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="dt">.funs =</span> custom_funs,</span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="dt">solar =</span> <span class="ot">TRUE</span>,</span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="dt">interval =</span> <span class="st">&#39;midday&#39;</span>, <span class="dt">int_start =</span> <span class="dv">11</span>, <span class="dt">int_end =</span> <span class="dv">13</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>)</span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">#&gt; [1] &quot;Crunching data for ARG_TRE. In large datasets this could take a while&quot;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">#&gt; [1] &quot;midday data for ARG_TRE&quot;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a>foo_simpler_metrics_midday[[<span class="st">&#39;sapf&#39;</span>]]</span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">#&gt; # A tibble: 13 x 9</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">#&gt;    TIMESTAMP_md        ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_…</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">#&gt;    &lt;dttm&gt;                         &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">#&gt;  1 2009-11-18 00:00:00             685.             665.             614.</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">#&gt;  2 2009-11-19 00:00:00             879.             594.             626.</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">#&gt;  3 2009-11-20 00:00:00             438.             272.             258.</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">#&gt;  4 2009-11-21 00:00:00             631.             379.             533.</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">#&gt;  5 2009-11-22 00:00:00             783.             535.             680.</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co">#&gt;  6 2009-11-23 00:00:00             841.             478.             618.</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">#&gt;  7 2009-11-24 00:00:00             951.             636.             789.</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co">#&gt;  8 2009-11-25 00:00:00             907.             602.             789.</span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">#&gt;  9 2009-11-26 00:00:00             861.             697.             925.</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">#&gt; 10 2009-11-27 00:00:00             806.             594.             706.</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">#&gt; 11 2009-11-28 00:00:00             837.             730.             925.</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="co">#&gt; 12 2009-11-29 00:00:00             638.             605.             666.</span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">#&gt; 13 2009-11-30 00:00:00             548.             371.             444.</span></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="co">#&gt; # … with 5 more variables: ARG_TRE_Nan_Jt_4_mean_md &lt;dbl&gt;,</span></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_1_std_dev_md &lt;dbl&gt;, ARG_TRE_Nan_Jt_2_std_dev_md &lt;dbl&gt;,</span></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_3_std_dev_md &lt;dbl&gt;, ARG_TRE_Nan_Jt_4_std_dev_md &lt;dbl&gt;</span></span></code></pre></div>
</div>
<div id="custom-aggregation-periods" class="section level2">
<h2>Custom aggregation periods</h2>
<p><code>period</code> argument in <code>sfn_metrics</code> is passed to <code>.collapse_timestamp</code> function, and so, it can use the same input:</p>
<ul>
<li>“frequency period” format, where frequency is a number and period is an interval as character (i.e. “1 year”, “7 days”)</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># weekly</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>foo_weekly &lt;-<span class="st"> </span><span class="kw">sfn_metrics</span>(</span>
<span id="cb3-3"><a href="#cb3-3"></a>  ARG_TRE,</span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="dt">period =</span> <span class="st">&#39;7 days&#39;</span>,</span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="dt">.funs =</span> custom_funs,</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="dt">solar =</span> <span class="ot">TRUE</span>,</span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="dt">interval =</span> <span class="st">&#39;general&#39;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>)</span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#&gt; [1] &quot;Crunching data for ARG_TRE. In large datasets this could take a while&quot;</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#&gt; [1] &quot;General data for ARG_TRE&quot;</span></span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a>foo_weekly[[<span class="st">&#39;env&#39;</span>]]</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">#&gt; # A tibble: 3 x 19</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">#&gt;   TIMESTAMP           ta_mean rh_mean vpd_mean sw_in_mean ws_mean precip_mean</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">#&gt;   &lt;dttm&gt;                &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co">#&gt; 1 2009-11-15 00:00:00    4.81    35.3    0.598       280.    15.5     0.00612</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">#&gt; 2 2009-11-22 00:00:00    6.15    35.3    0.656       327.    24.5     0.192  </span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">#&gt; 3 2009-11-29 00:00:00    2.55    40.9    0.453       261.    23.1     0.122  </span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">#&gt; # … with 12 more variables: swc_shallow_mean &lt;dbl&gt;, ppfd_in_mean &lt;dbl&gt;,</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">#&gt; #   ext_rad_mean &lt;dbl&gt;, ta_std_dev &lt;dbl&gt;, rh_std_dev &lt;dbl&gt;, vpd_std_dev &lt;dbl&gt;,</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">#&gt; #   sw_in_std_dev &lt;dbl&gt;, ws_std_dev &lt;dbl&gt;, precip_std_dev &lt;dbl&gt;,</span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co">#&gt; #   swc_shallow_std_dev &lt;dbl&gt;, ppfd_in_std_dev &lt;dbl&gt;, ext_rad_std_dev &lt;dbl&gt;</span></span></code></pre></div>
<ul>
<li>A custom function name (without quotes). This way you can build irregular or custom periods. This function first argument must always be the timestamp to be collapsed, and can have other arguments that will be supplied in the dots (<code>...</code>) argument of <code>sfn_metrics</code>. Also, this function always must return a vector of timestamps of the same length as the original timestamp.<br />
For example, if you want to summarise by quarters we can use the <code>quarter</code> function from the lubridate package:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>foo_custom &lt;-<span class="st"> </span><span class="kw">sfn_metrics</span>(</span>
<span id="cb4-2"><a href="#cb4-2"></a>  AUS_CAN_ST2_MIX,</span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="dt">period =</span> lubridate<span class="op">::</span>quarter, <span class="co"># period is the name of the function now</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="dt">.funs =</span> custom_funs,</span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="dt">solar =</span> <span class="ot">TRUE</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="dt">interval =</span> <span class="st">&#39;general&#39;</span>,</span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="dt">with_year =</span> <span class="ot">TRUE</span> <span class="co"># argument for lubridate::quarter</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>)</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&gt; [1] &quot;Crunching data for AUS_CAN_ST2_MIX. In large datasets this could take a while&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#&gt; Warning in .period_to_minutes(period, .data$TIMESTAMP, unique(.data$timestep)): when using a custom function as period, coverage calculation</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">#&gt;             can be less accurate</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#&gt; Warning in .period_to_minutes(period, .data$TIMESTAMP, unique(.data$timestep)): when using a custom function as period, coverage calculation</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#&gt;             can be less accurate</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#&gt; [1] &quot;General data for AUS_CAN_ST2_MIX&quot;</span></span></code></pre></div>
</div>
<div id="extra-parameters" class="section level2">
<h2>Extra parameters</h2>
<p><code>sfn_metrics</code> has a <code>...</code> parameter intended to supply additional parameters to the internal functions used:</p>
<ol style="list-style-type: decimal">
<li><p><code>.collapse_timestamp</code> accepts the following extra arguments:</p>
<ul>
<li><code>side</code><br />
“start” by default in the sfn_metrics implementation</li>
</ul></li>
<li><p><code>dplyr::summarise_all</code> accepts extra arguments intended to be applied to the summarising functions provided (to <strong>all</strong>, so they all must have the argument provided or an error will be raised). That’s the reason because we recommend to use the list way, as the arguments are specified for the individual functions.</p></li>
</ol>
<p>For example, if we want the TIMESTAMPs after aggregation to show the end of the period instead the begining (default) we can do the following:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>foo_simpler_metrics_end &lt;-<span class="st"> </span><span class="kw">sfn_metrics</span>(</span>
<span id="cb5-2"><a href="#cb5-2"></a>  ARG_TRE,</span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="dt">period =</span> <span class="st">&#39;1 day&#39;</span>,</span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="dt">.funs =</span> custom_funs,</span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="dt">solar =</span> <span class="ot">TRUE</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="dt">interval =</span> <span class="st">&#39;general&#39;</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="dt">side =</span> <span class="st">&quot;end&quot;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>)</span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#&gt; [1] &quot;Crunching data for ARG_TRE. In large datasets this could take a while&quot;</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">#&gt; [1] &quot;General data for ARG_TRE&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a>foo_simpler_metrics_end[[<span class="st">&#39;sapf&#39;</span>]]</span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">#&gt; # A tibble: 14 x 9</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co">#&gt;    TIMESTAMP           ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_…</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">#&gt;    &lt;dttm&gt;                         &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co">#&gt;  1 2009-11-18 00:00:00             308.             173.             303.</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">#&gt;  2 2009-11-19 00:00:00             507.             376.             432.</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="co">#&gt;  3 2009-11-20 00:00:00             541.             380.             391.</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co">#&gt;  4 2009-11-21 00:00:00             330.             218.             272.</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co">#&gt;  5 2009-11-22 00:00:00             338.             219.             278.</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="co">#&gt;  6 2009-11-23 00:00:00             384.             243.             310.</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="co">#&gt;  7 2009-11-24 00:00:00             492.             300.             390.</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="co">#&gt;  8 2009-11-25 00:00:00             573.             389.             497.</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="co">#&gt;  9 2009-11-26 00:00:00             601.             400.             484.</span></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="co">#&gt; 10 2009-11-27 00:00:00             502.             360.             450.</span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="co">#&gt; 11 2009-11-28 00:00:00             544.             411.             506.</span></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="co">#&gt; 12 2009-11-29 00:00:00             573.             451.             589.</span></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="co">#&gt; 13 2009-11-30 00:00:00             371.             285.             357.</span></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="co">#&gt; 14 2009-12-01 00:00:00             386.             293.             381.</span></span>
<span id="cb5-30"><a href="#cb5-30"></a><span class="co">#&gt; # … with 5 more variables: ARG_TRE_Nan_Jt_4_mean &lt;dbl&gt;,</span></span>
<span id="cb5-31"><a href="#cb5-31"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_1_std_dev &lt;dbl&gt;, ARG_TRE_Nan_Jt_2_std_dev &lt;dbl&gt;,</span></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_3_std_dev &lt;dbl&gt;, ARG_TRE_Nan_Jt_4_std_dev &lt;dbl&gt;</span></span></code></pre></div>
<p>If it is compared with the <code>foo_simpler_metrics</code> calculated before, now the period is identified in the TIMESTAMP by the ending of the period (daily in this case).</p>
<blockquote>
<p>When supplying custom functions as “period” argument, the default coverage statistic is not reliable as there is no way of knowing beforehand the period/s in minutes.</p>
</blockquote>
</div>
<div id="temporary-columns-helpers" class="section level2">
<h2>Temporary columns helpers</h2>
<p>The internal aggregation process in <code>sfn_metrics</code> generates some transitory columns which can be used in the summarising functions:</p>
<div id="timestamp_coll" class="section level3">
<h3><code>TIMESTAMP_coll</code></h3>
<p>When aggregating by the declared period (i.e. <code>&quot;daily&quot;</code>), the TIMESTAMP column collapses to the period start/end value (meaning that all the TIMESTAMP values for the same day becomes identical).<br />
This makes impossible to use any summarise functions that obtain the time of the day at which one event happens (i.e. time of the day at which the maximum sap flow occurs) because all TIMESTAMP values are identical. For that kind of summarising functions, a transitory column called <code>TIMESTAMP_coll</code> is created. So in this case we can create a function that takes de variable values for the day, the TIMESTAMP_coll values for the day and return the TIMESTAMP at which the max sap flow occurs and use it with <code>sfn_metrics</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>max_time &lt;-<span class="st"> </span><span class="cf">function</span>(x, time) {</span>
<span id="cb6-2"><a href="#cb6-2"></a>  </span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="co"># x: vector of values for a day</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="co"># time: TIMESTAMP for the day </span></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="co"># if all the values in x are NAs (a daily summmarise of no measures day for</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="co"># example) this will return a length 0 POSIXct vector, which will crash</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="co"># dplyr summarise step. So, check if all NA and if true return NA as POSIXct</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="cf">if</span>(<span class="kw">all</span>(<span class="kw">is.na</span>(x))) {</span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="kw">return</span>(<span class="kw">as.POSIXct</span>(<span class="ot">NA</span>, <span class="dt">tz =</span> <span class="kw">attr</span>(time, <span class="st">&#39;tz&#39;</span>), <span class="dt">origin =</span> lubridate<span class="op">::</span>origin))</span>
<span id="cb6-11"><a href="#cb6-11"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-12"><a href="#cb6-12"></a>    time[<span class="kw">which.max</span>(x)]</span>
<span id="cb6-13"><a href="#cb6-13"></a>  }</span>
<span id="cb6-14"><a href="#cb6-14"></a>}</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a>custom_funs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">max =</span> <span class="op">~</span><span class="st"> </span><span class="kw">max</span>(., <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="op">~</span><span class="st"> </span><span class="kw">max_time</span>(., TIMESTAMP_coll))</span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a>max_time_metrics &lt;-<span class="st"> </span><span class="kw">sfn_metrics</span>(</span>
<span id="cb6-19"><a href="#cb6-19"></a>  ARG_TRE,</span>
<span id="cb6-20"><a href="#cb6-20"></a>  <span class="dt">period =</span> <span class="st">&#39;1 day&#39;</span>,</span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="dt">.funs =</span> custom_funs,</span>
<span id="cb6-22"><a href="#cb6-22"></a>  <span class="dt">solar =</span> <span class="ot">TRUE</span>,</span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="dt">interval =</span> <span class="st">&#39;general&#39;</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>)</span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">#&gt; [1] &quot;Crunching data for ARG_TRE. In large datasets this could take a while&quot;</span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="co">#&gt; [1] &quot;General data for ARG_TRE&quot;</span></span>
<span id="cb6-27"><a href="#cb6-27"></a></span>
<span id="cb6-28"><a href="#cb6-28"></a>max_time_metrics[[<span class="st">&#39;sapf&#39;</span>]]</span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co">#&gt; # A tibble: 14 x 9</span></span>
<span id="cb6-30"><a href="#cb6-30"></a><span class="co">#&gt;    TIMESTAMP           ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_… ARG_TRE_Nan_Jt_…</span></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co">#&gt;    &lt;dttm&gt;                         &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="co">#&gt;  1 2009-11-17 00:00:00             322.             190.             313.</span></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="co">#&gt;  2 2009-11-18 00:00:00             778.             715.             679.</span></span>
<span id="cb6-34"><a href="#cb6-34"></a><span class="co">#&gt;  3 2009-11-19 00:00:00            1015.             694.             633.</span></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co">#&gt;  4 2009-11-20 00:00:00             648.             401.             442.</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="co">#&gt;  5 2009-11-21 00:00:00             664.             406.             539.</span></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="co">#&gt;  6 2009-11-22 00:00:00             812.             564.             816.</span></span>
<span id="cb6-38"><a href="#cb6-38"></a><span class="co">#&gt;  7 2009-11-23 00:00:00            1085.             676.             935.</span></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="co">#&gt;  8 2009-11-24 00:00:00             992.             736.            1115.</span></span>
<span id="cb6-40"><a href="#cb6-40"></a><span class="co">#&gt;  9 2009-11-25 00:00:00             976.             646.             951.</span></span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="co">#&gt; 10 2009-11-26 00:00:00             932.             766.            1087.</span></span>
<span id="cb6-42"><a href="#cb6-42"></a><span class="co">#&gt; 11 2009-11-27 00:00:00             862.             704.             921.</span></span>
<span id="cb6-43"><a href="#cb6-43"></a><span class="co">#&gt; 12 2009-11-28 00:00:00             845.             763.            1165.</span></span>
<span id="cb6-44"><a href="#cb6-44"></a><span class="co">#&gt; 13 2009-11-29 00:00:00             714.             747.             701.</span></span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="co">#&gt; 14 2009-11-30 00:00:00             875.             646.             919.</span></span>
<span id="cb6-46"><a href="#cb6-46"></a><span class="co">#&gt; # … with 5 more variables: ARG_TRE_Nan_Jt_4_max &lt;dbl&gt;,</span></span>
<span id="cb6-47"><a href="#cb6-47"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_1_max_time &lt;dttm&gt;, ARG_TRE_Nan_Jt_2_max_time &lt;dttm&gt;,</span></span>
<span id="cb6-48"><a href="#cb6-48"></a><span class="co">#&gt; #   ARG_TRE_Nan_Jt_3_max_time &lt;dttm&gt;, ARG_TRE_Nan_Jt_4_max_time &lt;dttm&gt;</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
